<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Update From Text</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 2rem; background-color: #f7f7f7; color: #333; }
        h1, h2 { color: #111; }
        .container { background-color: #fff; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 800px; margin: auto; }
        textarea { width: 100%; height: 200px; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-family: monospace; margin-bottom: 1rem; }
        button { background-color: #007bff; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 4px; font-size: 1rem; cursor: pointer; transition: background-color 0.2s; margin-right: 1rem; }
        button:hover { background-color: #0056b3; }
        #confirm-btn { background-color: #28a745; display: none; }
        #confirm-btn:hover { background-color: #218838; }
        table { width: 100%; border-collapse: collapse; margin-top: 1.5rem; }
        th, td { border: 1px solid #ddd; padding: 0.75rem; text-align: left; }
        th { background-color: #f2f2f2; }
        #response-message { margin-top: 1rem; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Update Rates From Text</h1>
        <p>Paste your unformatted exchange rates below. The system will try to extract the currency, buy price, and sell price from each line.</p>
        
        <textarea id="raw-text" placeholder="Example:&#10;USD 90.5 91.8&#10;EUR 96.2 / 97.3&#10;CHF, 101.1, 102.5"></textarea>
        
        <button id="process-btn">Process Text</button>
        <button id="confirm-btn">Confirm and Update Rates</button>
        
        <div id="preview-area">
            <h2>Preview</h2>
            <p>Please review the extracted data. If it looks correct, click "Confirm and Update".</p>
            <table id="preview-table">
                <thead>
                    <tr>
                        <th>Currency</th>
                        <th>Buy (Blerje)</th>
                        <th>Sell (Shitje)</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Parsed data will appear here -->
                </tbody>
            </table>
        </div>
        
        <p id="response-message"></p>
    </div>

    <script>
        const processBtn = document.getElementById('process-btn');
        const confirmBtn = document.getElementById('confirm-btn');
        const rawTextArea = document.getElementById('raw-text');
        const previewArea = document.getElementById('preview-area');
        const previewTableBody = document.querySelector('#preview-table tbody');
        const responseMessage = document.getElementById('response-message');

        let parsedDataForUpload = {}; // This will hold the clean data to be sent to the API

        previewArea.style.display = 'none'; // Hide preview initially

        processBtn.addEventListener('click', () => {
            const text = rawTextArea.value;
            const lines = text.split('\n').filter(line => line.trim() !== '');
            
            parsedDataForUpload = {}; // Reset data
            previewTableBody.innerHTML = ''; // Clear table
            
            lines.forEach(line => {
                // Find a 3-letter uppercase currency code
                const currencyMatch = line.match(/[A-Z]{3}/);
                // Find all numbers (including decimals)
                const numberMatches = line.match(/\d+(\.\d+)?/g);

                if (currencyMatch && numberMatches && numberMatches.length >= 2) {
                    const currency = currencyMatch[0];
                    const buy = parseFloat(numberMatches[0]);
                    const sell = parseFloat(numberMatches[1]);
                    
                    // Add to table for preview
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${currency}</td>
                        <td>${buy.toFixed(4)}</td>
                        <td>${sell.toFixed(4)}</td>
                    `;
                    previewTableBody.appendChild(row);

                    // Prepare data for API upload
                    parsedDataForUpload[currency] = { buy, sell };
                }
            });

            if (Object.keys(parsedDataForUpload).length > 0) {
                previewArea.style.display = 'block';
                confirmBtn.style.display = 'inline-block';
                responseMessage.textContent = '';
            } else {
                 responseMessage.textContent = 'Could not find any valid data to parse. Please check the format.';
                 responseMessage.style.color = 'red';
                 previewArea.style.display = 'none';
                 confirmBtn.style.display = 'none';
            }
        });

        confirmBtn.addEventListener('click', async () => {
            responseMessage.textContent = 'Updating...';
            confirmBtn.disabled = true;

            try {
                const response = await fetch('/api/update-rates', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ rates: parsedDataForUpload }), // Send the structured data
                });

                const result = await response.json();

                if (response.ok) {
                    responseMessage.textContent = 'Success! Rates have been updated.';
                    responseMessage.style.color = 'green';
                } else {
                    throw new Error(result.message || 'An unknown error occurred.');
                }

            } catch (error) {
                responseMessage.textContent = `Error: ${error.message}`;
                responseMessage.style.color = 'red';
            } finally {
                confirmBtn.disabled = false;
            }
        });
    </script>
</body>
</html>

